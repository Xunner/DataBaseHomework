# 数据库作业——数据库设计

[TOC]

## 原始题目

#### 移动运营商业务数据库设计与实现

​	我们现在的生活与手机息息相关，而支撑起这一套复杂的移动通讯网络不光是硬件设备上的支持，后台系统也必须灵活而可靠。因此，作为系统重要的一环，运营商的数据库设计是一个相当大的挑战。请结合本课程相关内容深入理解，对某运营商A的移动网络业务数据库结构进行简要的设计，并完成以下问题：

1. 使用MySQL关系型数据库，设计所有相关的数据表。
2. 自行创建测试数据，进行如下操作：
  - 对某个用户进行套餐的查询（包括历史记录）、订购、退订（考虑立即生效和次月生效）操作
  - 某个用户在通话情况下的资费生成
  - 某个用户在使用流量情况下的资费生成
  - 某个用户月账单的生成
3. 相应操作请记录所用时间。
4. 回顾设计方案，简单谈一谈可能的优化思路（在说明文档中简要说明）。

#### 设计要求及参考

1. 资费
  - 基准资费
    - 通话费用：0.5元/分钟（仅拨打收费，接听免费）
    - 短信费用：0.1元/条
    - 本地流量费用（仅考虑4G流量）：2元/M
    - 国内流量费用（仅考虑4G流量）：5元/M
  - 优惠套餐参考
    - 话费套餐：月功能费20元，最多可拨打100分钟电话，超出时间按照0.5元/分钟计费。
    - 短信套餐：月功能费10元，最多可发送200条短信，超出条数按0.1元/条计费。
    - 本地流量套餐：月功能费20元，最多可获得2G流量，仅在本地使用，超出流量按2元/M计费。
    - 国内流量套餐：月功能费30元，最多可获得2G流量，超出流量按5元/M计费。
  - 套餐可自行设计
  - 考虑一个套餐中带有多种资费优惠类型
  - 考虑不同套餐叠加的情况
2. 网络服务地区
  - 考虑本地流量和国内流量在计费上的差别。

## 数据库ER图

![ER Model](img/ER.png)

## 总体设计

#### 订单（order）：

​	用户每次订购都会生成一条记录存于orders表中。退订不会删除记录，只会将状态（state）改为次月失效（INVALID NEXT MONTH）或已失效（INVALID）。每条状态为有效（VALID）的订单记录都会在下一个月自动生成一条次月的订单记录；其他状态（次月失效以及已失效）的订单不会生成新的记录（由业务逻辑实现，本程序未给出）。

#### 资费（expense）：

​	分为通话（call）、短信（message）、流量（data）三种资费。生成资费记录时由业务逻辑检查可用套餐订单。一笔资费若计算在某订单内，则记录相应订单id（order_id）并将费用（cost）记为0，否则无订单id（记为null）并记录相应费用。

## 操作设计

#### 1. 订购

- 设计：检查账户余额，充足则插入订单数据。
- 运行截图：![订购](img/订购.png)
- 时间：0.016s

#### 2. 退订（立即生效）

- 设计：将对应订单的状态改为已失效（INVALID）。
- 运行截图：![立即退订](img/立即退订.png)
- 时间：0.01s

#### 3. 退订（次月生效）

- 设计：将对应订单的状态改为已失效（INVALID NEXT MONTH）。
- 运行截图：![次月退订](img/次月退订.png)
- 时间：0.005s

#### 4. 查询套餐订购记录

- 设计：作为历史记录查询，只联表查询订单（orders表）日期、状态和套餐（plans表）信息
- 运行截图：![查询套餐订购记录](img/查询套餐订购记录.png)
- 时间：0.013s

#### 5. 生成通话资费

- 设计：

  （1）首先查询所有当月生效中的订单；

  （2）根据订单id在通话资费表（call_expenses）中统计当月订单内通话时长，计算余量；

  （3）遍历查询仍有余量的订单生成套餐内通话资费记录；

  （4）若该套餐订单余量不足，则寻找下一订单为剩余通话时长再生成另外一条记录；

  （5）若最后无可用订单则生成一条套餐外记录，并扣除相应账户余额。

- 运行截图：![生成通话资费](img/生成通话资费.png)

- 时间：0.021s

#### 6. 生成短信资费

- 设计：调用一次接口代表为一条短信生成资费记录。

  （1）首先查询所有当月生效中的订单；

  （2）根据订单id在短信资费表（message_expenses）中统计当月订单内短信条数，计算余量；

  （3）遍历查询仍有余量的订单生成套餐内短信资费记录；

  （4）若无可用订单则生成一条套餐外记录，并扣除相应账户余额。

- 运行截图：![生成短信资费](img/生成短信资费.png)

- 时间：0.019s

#### 7. 生成流量资费

- 设计：

  （1）首先根据流量类型（本地或全国）查询所有当月生效中的订单；

  （2）根据订单id在流量资费表（data_expenses）中统计当月订单内流量，计算余量；

  （3）遍历查询仍有（本地或全国流量）余量的订单生成套餐内流量资费记录；

  （4）若该套餐订单余量不足，则寻找下一订单为剩余流量再生成另外一条记录；

  （5）若为本地流量但无可用本地流量套餐余量，则再查询全国流量套餐；

  （6）若最后无可用订单则生成一条套餐外记录，并扣除相应账户余额。

- 运行截图：![生成流量资费](img/生成流量资费.png)

- 时间：0.015s

#### 8. 生成月账单

- 设计：

  （1）首先联表查询所有该年该月生效的订单（orders表）和套餐（plans表）信息；

  （2）根据订单id在三种资费表中统计当月订单使用情况，计算余量，展示订单信息；

  （3）在三种资费表中统计当月订单外使用情况，计算费用，展示信息和费用总额。

- 运行截图：![生成月账单](img/生成月账单.png)

- 时间：0.067s